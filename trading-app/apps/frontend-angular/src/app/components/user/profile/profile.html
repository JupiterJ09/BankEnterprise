<div class="profile-container" *ngIf="user">
  
  <aside class="profile-card">
    <div class="avatar-section">
      <div class="avatar-circle">
        {{ user.firstName.charAt(0) }}
      </div>
      <h2>{{ user.firstName }} {{ user.lastName }}</h2>
      <span class="role-badge">{{ user.role }}</span>
    </div>

    <div class="info-list">
      <div class="info-item">
        <span class="material-symbols-rounded icon">calendar_month</span>
        <div>
          <label>Miembro desde</label>
          <p>{{ user.createdAt | date:'mediumDate' }}</p>
        </div>
      </div>
      <div class="info-item">
        <span class="material-symbols-rounded icon">verified_user</span>
        <div>
          <label>Estado</label>
          <p class="status-active">Verificado</p>
        </div>
      </div>
    </div>
  </aside>

  <section class="profile-content">
    
    <div class="tabs">
      <button [class.active]="activeTab === 'personal'" (click)="setActiveTab('personal')">
        Información Personal
      </button>
      <button [class.active]="activeTab === 'security'" (click)="setActiveTab('security')">
        Seguridad
      </button>
    </div>

    <div class="tab-content" *ngIf="activeTab === 'personal'">
      <div class="header-row">
        <h3>Datos de la Cuenta</h3>
        <button class="btn-edit" (click)="toggleEdit()">
          <span class="material-symbols-rounded">{{ isEditing ? 'close' : 'edit' }}</span>
          {{ isEditing ? 'Cancelar' : 'Editar' }}
        </button>
      </div>

      <form [formGroup]="profileForm" (ngSubmit)="saveChanges()">
        <div class="form-grid">
          
          <div class="form-group">
            <label>Nombre</label>
            <input type="text" formControlName="firstName" [readonly]="!isEditing" [class.editable]="isEditing">
          </div>

          <div class="form-group">
            <label>Apellido</label>
            <input type="text" formControlName="lastName" [readonly]="!isEditing" [class.editable]="isEditing">
          </div>

          <div class="form-group full-width">
            <label>Correo Electrónico</label>
            <input type="email" formControlName="email" readonly class="disabled-input">
            <small class="hint">El correo no se puede cambiar por seguridad.</small>
          </div>

          <div class="form-group full-width">
            <label>Teléfono</label>
            <input type="tel" formControlName="phone" [readonly]="!isEditing" [class.editable]="isEditing" placeholder="+52...">
          </div>

        </div>

        <div class="form-actions" *ngIf="isEditing">
          <button type="submit" class="btn-save" [disabled]="profileForm.invalid">Guardar Cambios</button>
        </div>
      </form>
    </div>

    <div class="tab-content" *ngIf="activeTab === 'security'">
      
      <div class="security-card" *ngIf="!isTwoFaEnabled && !showQrCode">
        <div class="icon-circle warning">
          <span class="material-symbols-rounded">g_pp</span> </div>
        <h3>Protege tu cuenta</h3>
        <p>La autenticación de dos factores (2FA) añade una capa extra de seguridad. Te pediremos un código de tu celular cada vez que inicies sesión.</p>
        <button class="btn-primary" (click)="initiateTwoFaSetup()">Activar 2FA</button>
      </div>

      <div class="setup-2fa" *ngIf="showQrCode">
        <h3>Configurar Autenticador</h3>
        <p>Escanea este código QR con tu aplicación (Google Authenticator o Authy).</p>
        
        <div class="qr-placeholder">
          <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=OtpAuthSimulado" alt="QR Code">
        </div>

        <div class="code-input-section">
          <label>Ingresa el código de 6 dígitos:</label>
          <input type="text" 
                 [(ngModel)]="twoFaCode" 
                 maxlength="6" 
                 placeholder="000 000"
                 class="input-code">
        </div>

        <div class="actions">
          <button class="btn-cancel" (click)="cancelTwoFaSetup()">Cancelar</button>
          <button class="btn-verify" 
                  [disabled]="twoFaCode.length < 6" 
                  (click)="verifyTwoFaCode()">Verificar y Activar</button>
        </div>
      </div>

      <div class="security-card active" *ngIf="isTwoFaEnabled">
        <div class="icon-circle success">
          <span class="material-symbols-rounded">verified_user</span>
        </div>
        <h3>Tu cuenta está blindada</h3>
        <p>La autenticación de dos factores está activa. Tu dinero está más seguro.</p>
        <button class="btn-danger-outline" (click)="disableTwoFa()">Desactivar 2FA</button>
      </div>

    </div>

  </section>

</div>